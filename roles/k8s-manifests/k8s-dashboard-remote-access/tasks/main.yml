---

- name: Ensure that kubernetes-dashboard namespace exists
  k8s:
    name: "{{ k8s_dashboard }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Create an admin service account
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: admin-user
        namespace: "{{ k8s_dashboard }}"

- name: Create an admin user role
  k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: admin-user
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: "{{ k8s_dashboard }}"

- name: Create an ingress resource
  k8s:
    state: present
    apply: true
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: kubernetes-dashboard-ingress
        namespace: "{{ k8s_dashboard }}"
        annotations:
          kubernetes.io/ingress.class: "traefik"
          traefik.ingress.kubernetes.io/rule-type: "PathPrefixStrip"
          traefik.ingress.kubernetes.io/ssl-redirect: "true"
      spec:
        rules:
          - host: raspberrypi
            http:
              paths:
                - path: /kubernetes
                  pathType: Prefix
                  backend:
                    service:
                      name: "{{ k8s_dashboard }}"
                      port:
                        number: 443
